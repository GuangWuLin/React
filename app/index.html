<html>
	<head>
		<title>消息助手</title>
		 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    	<meta http-equiv="content-type" content="text/html; charset=utf-8" />	
	    <script src="../thr/js/jquery.min.js" ></script>
	    <script src="../thr/js/JSXTransformer.js"></script>
	    <script src="../thr/js/react.js"></script>
		<script src="../thr/js/react-dom.js"></script>
	    <script src="../thr/js/browser.min.js"></script>
	    <!-- The core React library -->
	    <link rel="stylesheet" type="text/css" href="./index.css"/>
	</head>
	<body>
		<script>window.$ = window.jQuery = require('../thr/js/jquery.min.js');</script>
		<div id="example">
			Loading....
		</div>
		<div id="tips"></div>
		<audio src="./audio/money.wav"></audio>
		<script type="text/jsx">
			var audio = document.querySelector('audio')
			var Login = 'http://192.168.1.51:9797/todo?method=login'; //&cb=funcxx
			var Logout = 'http://192.168.1.51:9797/todo?method=logout' // &cb=funcxx
			var GetNew = 'http://192.168.1.51:9797/todo?method=getnew' ; //
			var getAll = 'http://192.168.1.51:9797/todo?method=getall'; //
			var getUser = 'http://192.168.1.51:9797/todo?method=user';

		const shell = require('electron').shell
		const ipcRenderer = require('electron').ipcRenderer;
		// 打开音效
		ipcRenderer.on('playBoy',()=>{
			console.log('playBoy')
			audio.play();
		})
		//关闭音效
		ipcRenderer.on('stopBoy',()=>{
			audio.pause()
		})


		// 金额转 3位 1逗号模式			
		var CashTo3 = (str)=>{
				let len = str.length, str2 = '', max = Math.floor(len / 3); 
				for(var i = 0 ; i < max ; i++){ 
					let s = str.slice(len - 3, len); 
					str = str.substr(0, len - 3); 
					str2 = (',' + s) + str2; 
					len = str.length; 
				} 
				str += str2; 
				return str;
			}
		// 跨域请求			
		var DataFromOut = (url,params,success,limit)=>{
				var params = params || null
				try{
					$.ajax({
						url:url,
						data:params,
						type:'POST',
						dataType:'jsonp',
						success:success,
						error:()=>{
							limit > 5 && alert('请求超时，请重试')
						}
					})
				}catch(e){
					alert(e.message)
				}
			}

		// 用户
			var users = [];
		
		// 待处理事项			

			var stodoLists = [];
			
		// 定时取新数据		

			var getData = function(){
				DataFromOut(GetNew,null,(r)=>{
					//console.log(r);
					if(r.data.length>0){
					// 存放获取到的新数据的数组
						// 根据时间排序
						let arr = r.data.sort((a,b)=>{
							return a.date - b.date;
						});
						let user = localStorage.getItem('userName')
						// 给主进程发消息 提示 有新数据输入
						ipcRenderer.send('newPush',[user,arr])

						//arr.forEach(c=>{
									//stodoLists.push(c);
						//});

						//console.log(arr)
					}
				},5);
				// 每隔 10s 获取一次
				setTimeout(getData,10000);
			}
		
		// 初始定时取所有数据
		var getAllData = function(time){
			setTimeout(getAllData,300000);
			return Promise.all([$.ajax({url:getAll,data:null,type:'post',dataType:'jsonp'})]);
			return Promise.reject();
			// 每过 5min 获取一次
		}

		
		//头像组件

			var HeadImgComponent = React.createClass({
				getInitialState:function(){
					return {isLogin:this.props.isLogin}
				},
				handleClick : function(){
					//console.log('is loaded')
					var newLogin = false
					this.setState({isLogin:newLogin});
					document.title = '消息助手'
					this.props.callbackParent(newLogin)
					ipcRenderer.send('Back');
				},
				render:function(){
					var isLogin = this.props.isLogin
					var sex = isLogin?this.props.sex:'unkown'
					//console.error(this.props.sex+'ssssssssssss'+isLogin)
					return <img onClick={this.handleClick} src={`../thr/img/${sex}.jpg`} />
				}
			});

		// 输入框组件
			var EnterComponent = React.createClass({
				getInitialState:function(){
					//console.info(this.props.isLogin)
					return {isLogin:this.props.isLogin,userName:'',password:''}
				},

				changeType:function(e){
					if(e.keyCode === 13 && !this.props.flag){
						// 输入用户名
						if(!this.props.isLogin){
							//console.log(0000)
							DataFromOut(getUser,{user:this.refs.myInput.value},(r)=>{
								//console.log(2222)
								//console.log(r);
								
								switch(r.code){
									case 200:
						
										var sex = r.data.sex?r.data.sex:'male';
										// 系统未定义用户性别时 默认为 male
										var newLogin = [!this.props.isLogin,r.data.title,sex]
										this.setState({isLogin:true,userName:r.data.title,sex:sex})
										//console.error(users[i].sex)
										// 存用户名（中文名）
										localStorage.setItem('userName',r.data.title);
										// 存用户账号 (名字的拼音)
										localStorage.setItem('user',r.data.user);
										// 存 用户姓名	(调用回调 )									
										this.props.callbackParent(newLogin)
										this.refs.myInput.value = '';
										break;
									case 404:
										alert('对不起，您输入的用户不存在，请查证后再输入');
										break;
								}
							},5);
						}else{
						// 输入用户密码		
							DataFromOut(Login,{user:localStorage.getItem('user'),passwd:this.refs.myInput.value},(r)=>{
								// 验证成功
								//console.log(r)
								if(r.msg === 'Login OK'){
								
									var newFlag = [true,this.props.isLogin];
								//	localStorage.setItem('item',this.state.userName)
									this.props.oncallback1(newFlag)
								}else if(r.msg ==='passwd error'){
									alert('密码错误')
								}
							},5);
						}
					}
				},
				render:function(){
					var flag = this.props.flag
					var isLogin = this.props.isLogin
					var Enter = !isLogin?'请输入账号':'请输入密码';
					var type = !isLogin?'text':'password';
					return (
						<input ref='myInput' type={type} placeholder={`${Enter}`} onKeyUp={this.changeType} autoFocus={focus} />
					)
				}
			});

		// 登陆组件
			var LoginComponent = React.createClass({
				getInitialState: function() {
				    return {isLogin: false,userName:'',sex:'unkown'};
				},
				onChildChanged: function (newLogin) {
				   this.setState({
				    isLogin: newLogin[0],
				    userName:newLogin[1],
				    sex:newLogin[2]
				  });
				},
				onChangeFlag(newFlag){
					this.props.oncallback(newFlag);
				},
				
				render:function(){
					var amLogin = this.state.userName
					var sex = this.state.sex
					var flag = this.props.flag;
					//console.warn(flag)
					return (
						<div className="acountEnter">
							<HeadImgComponent isLogin={this.state.isLogin} callbackParent={this.onChildChanged} sex={sex}/>
							<p style={{color:'white',textAlign:'center',fontSize:'25px'}}>{amLogin}</p>
							<EnterComponent isLogin={this.state.isLogin} callbackParent={this.onChildChanged} flag = {flag} oncallback1={this.onChangeFlag}/>
						</div>
					)
				}
			})

		// 页脚统计组件
			var TotalCountComponent = React.createClass({
				render:function(){
					let totalCount = 0;
					if(this.props.stodos.length>0){
						this.props.stodos.forEach(c=>{
							//console.log(typeof c.amount)
							totalCount += parseFloat(c.amount);
						});
					}
					totalCount += '';
					
					//console.info(totalCount)
					
					totalCount = CashTo3(totalCount);
					//console.log(typeof totalCount)
					return (
						<p style={{textAlign:'right'}}>总计&nbsp;￥ {totalCount}</p>
					)
				}
			}) 

		// 表单组件
			var TableComponent = React.createClass({
				getInitialState:function(){
					return {stodo:this.props.stodos}
				},
				render:function(){
					var todolist = [];
					if(this.state.stodo.length>0){
						this.state.stodo.forEach((todo,index)=>{
							todolist.push(<Todo todo={todo} key={index} pos={index} myUrl={todo.url}/>)
						});
					}
					return (
						<table className="imageTable">
							<thead>
								<tr>
									<th>序号</th>
									<th>日期</th>
									<th>项目</th>
									<th>事由</th>
									<th>金额</th>
									<th>经办人</th>
								</tr>
							</thead>
							<tbody>{todolist}</tbody>
						</table>
					)
				}
			})

		// 表-行 组件
			var Todo = React.createClass({
				showMeSomething:function(e){
					var text = e.target.parentNode.innerText;
					//console.info(text)
					//console.warn(this.props.index);
					var node = text.replace(/\s/g,'+').split('+')
					//console.log(node)	
					var oDiv = document.querySelector('#tips');
				   	oDiv.innerText = `序号 -> ${node[0]} \n 时间 -> ${node[1]}  ${node[2]} \n项目 -> ${node[3]} \n事由 -> ${node[4]} \n金额 -> ${node[5]} \n经办人 -> ${node[6]}`;
					oDiv.style.left = e.clientX + 'px'
					oDiv.style.top = e.clientY + 'px'
					oDiv.style.display = 'block'
					//console.log(oDiv)
					//console.info(e.clientX)
				},
				drag(){
					const url = this.props.myUrl
					shell.openExternal(url)
				},
				hideMeMessage:function(){
					document.querySelector('#tips').style.display = 'none';
				},
		        render: function() {
		          return (
		                <tr onMouseOver={this.showMeSomething} onMouseLeave={this.hideMeMessage} className="HighLight"  onMouseDown={this.drag}>
							<td className='Order'>{this.props.pos+1}</td>
							<td className='left' style={{width:'15rem'}}>{this.props.todo.date}</td>
							<td className='left'>{this.props.todo.project}</td>
							<td className='left'>{this.props.todo.cause}</td>
							<td className='right'>{this.props.todo.amount}元</td>
							<td className='hander'>{this.props.todo.creater}</td>
						</tr>
		            );
		        }
		    });	


		// 页眉组件
			var TodoListsComponent = React.createClass({
				render:function(){
					var todos = this.props.todoList
					return (
						<div>
							<TableComponent stodos={todos} />
							<TotalCountComponent stodos={todos}/>
						</div>
					)
				}
			})


		// 内容组件
			var ContentComponent = React.createClass({
				componentWillMount(){
					getData();
				},
				render:function(){
					var todoList = this.props.todoLists
					return <TodoListsComponent todoList={todoList} />
				}
			})

		// 大包装
			var App = React.createClass({
				getInitialState:function(){
					return {flag:false,isLogin:false,list:[]}
				},
				componentWillMount(){
					console.log(this.state.flag)
					getAllData(5).then(val=>{
						console.log(val[0].data)
						let arr = val[0].data;
						if(typeof arr !=='string' && arr.length>0){
							val[0].data.forEach((c,i)=>{
								c.oper === 'DELETE' && val[0].data.splice(i,1);
							});
							this.setState({list:val[0].data})
						}
						console.log(this.state.list)
						this.props.flag || [ipcRenderer.send('FirstData',this.state.list)]
					}).catch(e=>{
						console.log(e)
						alert('连接超时，请重试')
					});
				},
				changeFlag:function(newFlag){
					this.setState({flag:newFlag[0],isLogin:newFlag[1]})
				},
				render:function(){
					var isLogin = this.state.isLogin;
					//console.log(localStorage.getItem('item'))
					var userName = localStorage.getItem('userName')
					//console.error(isLogin)
					// 渲染进程（响应） -> 进入主页
					//console.error(isLogin)
					if(this.state.list.length >0 && isLogin) audio.play()
					ipcRenderer.on('showContent',()=>{
						//  必须在已经登录的状态才能进入主页
						this.state.isLogin && this.setState({flag:true})
						this.state.isLogin || alert('Please login first')
					});
					// 修改 title
					isLogin && [document.title = `消息助手-当前用户: ( ${userName} ) 待处理事项 ${this.state.list.length>0?this.state.list.length:'无'}`]
					// 用户登录 主进程（响应） -> 显示用户是谁
					this.state.isLogin && [ipcRenderer.send('userLogin',userName)]

					// 渲染进程（响应）-> 注销
					ipcRenderer.on('Logout',()=>{
						localStorage.removeItem('item')
						document.title = '消息助手';
						this.setState({flag:false,isLogin:false})
					});
					// 替换
					ipcRenderer.on('checkLists',(event,msg)=>{
						this.setState({list:msg});
						//console.log(event,msg)
					});
					var tmp = (this.state.flag & this.state.list.length>0)?<ContentComponent todoLists={this.state.list} flag={this.state.flag}/>: <LoginComponent flag={this.state.flag} oncallback={this.changeFlag}/>
					return (
						<div>{tmp}</div>
					)
				}
			})

			ReactDOM.render(
				<div>
					<App />
					
				</div>
				,document.getElementById('example')
			);
		</script>
	</body>
</html>