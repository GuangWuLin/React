<html>
	<head>
		<title>消息助手</title>
		 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    	<meta http-equiv="content-type" content="text/html; charset=utf-8" />	
	    <script src="../thr/js/jquery.min.js" ></script>
	    <script src="../thr/js/JSXTransformer.js"></script>
	    <script src="../thr/js/react.js"></script>
		<script src="../thr/js/react-dom.js"></script>
	    <script src="../thr/js/browser.min.js"></script>
	    <!-- The core React library -->
	    <link rel="stylesheet" type="text/css" href="./index.css"/>
	</head>
	<body>
		<script>window.$ = window.jQuery = require('../thr/js/jquery.min.js');</script>
		<div id="example">
			Loading....
		</div>
		<div id="tips"></div>
		<audio src="./audio/money.wav"></audio>
		<script type="text/jsx">
			var audio = document.querySelector('audio')
			var Login = 'http://192.168.1.51:9797/todo?method=login'; //&cb=funcxx
			var Logout = 'http://192.168.1.51:9797/todo?method=logout' // &cb=funcxx
			var GetNew = 'http://192.168.1.51:9797/todo?method=getnew' ; //
			var getAll = 'http://192.168.1.51:9797/todo?method=getall'; //
			var getUser = 'http://192.168.1.51:9797/todo?method=user';


		// 金额转 3位 1逗号模式			
		var CashTo3 = (str)=>{
				let len = str.length, str2 = '', max = Math.floor(len / 3); 
				for(var i = 0 ; i < max ; i++){ 
					let s = str.slice(len - 3, len); 
					str = str.substr(0, len - 3); 
					str2 = (',' + s) + str2; 
					len = str.length; 
				} 
				str += str2; 
				return str;
			}
		// 跨域请求			
		var DataFromOut = (url,params,success,error)=>{
				var params = params || null
				$.ajax({
					url:url,
					data:params,
					type:'POST',
					dataType:'jsonp',
					success:success,
					error:error
				})
			}

		// 用户
			var users = [];
			// {'acount':'111','name':'??','password':'123','sex':'male'},
			// {'acount':'222','name':'???','password':'123','sex':'female'},
			// {'acount':'333','name':'??','password':'123','sex':'male'}
		
		// 待处理事项			

			var stodoLists = [];
			
		// 定时取新数据			

			var getData = function(){
				DataFromOut(GetNew,null,(r)=>{
					//console.log(r);
					if(r.data){
						let newArr = [];
						r.data.forEach(c=>{
								
									//stodoLists.push(c);
									newArr.push(c);
									var user = localStorage.getItem('userName')
									ipcRenderer.send('newPush',[user,newArr])
								
						
						});
						console.log(newArr)
					}
				},(r)=>{
					console.log(r);
				});
				setTimeout(()=>{
					getData()
				},20000);
			}
		
		//头像组件

			var HeadImgComponent = React.createClass({
				getInitialState:function(){
					return {isLogin:this.props.isLogin}
				},
				handleClick : function(){
					var newLogin = false
					this.setState({isLogin:newLogin});
					document.title = '消息助手'
					this.props.callbackParent(newLogin)
				},
				render:function(){
					var isLogin = this.props.isLogin
					var sex = isLogin?this.props.sex:'unkown'
					//console.error(this.props.sex+'ssssssssssss'+isLogin)
					return <img onClick={this.handleClick} src={`../thr/img/${sex}.jpg`} />
				}
			});

		// 输入框组件
			var EnterComponent = React.createClass({
				getInitialState:function(){
					//console.info(this.props.isLogin)
					return {isLogin:this.props.isLogin,userName:'',password:''}
				},

				changeType:function(e){
					if(e.keyCode === 13 && !this.props.flag){
						// 输入用户名						
						if(!this.props.isLogin){
							DataFromOut(getUser,{user:this.refs.myInput.value},(r)=>{
								console.log(r);
								switch(r.code){
									case 200:
										DataFromOut(getAll,null,(r)=>{
											stodoLists = r.data
											console.log(r.data)
										},(r)=>{
											console.log(r)
										})
										var sex = r.data.sex?r.data.sex:'male';
										// 系统未定义用户性别时 默认为 male
										var newLogin = [!this.props.isLogin,r.data.user,sex]
										this.setState({isLogin:true,userName:r.data.title,sex:sex})
										//console.error(users[i].sex)
										localStorage.setItem('userName',r.data.title);
										localStorage.setItem('user',r.data.user);
										// 存 用户姓名										
										this.props.callbackParent(newLogin)
										this.refs.myInput.value = '';
										break;
									case 404:
										alert('对不起，您输入的用户不存在，请查证后再输入');
										break;
									case 500:
										alert('对不起，服务器错误，请稍后再试')
										break;
								}
							},(r)=>{
								console.log(r);
							});
						}else{
						// 输入用户密码							
							DataFromOut(Login,{user:localStorage.getItem('user'),passwd:this.refs.myInput.value},(r)=>{
								// 验证成功
								console.log(r)
								if(r.msg === 'Login OK'){
								// 修改 title
									document.title = `消息助手-当前用户: ( ${this.state.userName} ) 待处理事项 ${stodoLists.length>0?stodoLists.length:'无'}`
									var newFlag = [true,this.props.isLogin];
									localStorage.setItem('item',this.state.userName)
									this.props.oncallback1(newFlag)
								}else if(r.msg ==='passwd error'){
									alert('密码错误')
								}
							},(r)=>{
								console.log(r);
							});
						}
					}
				},
				render:function(){
					var flag = this.props.flag
					var isLogin = this.props.isLogin
					var Enter = !isLogin?'请输入账号':'请输入密码';
					var type = !isLogin?'text':'password';
					return (
						<input ref='myInput' type={type} placeholder={`${Enter}`} onKeyUp={this.changeType} autoFocus={focus} />
					)
				}
			});

		// 登陆组件
			var LoginComponent = React.createClass({
				getInitialState: function() {
				    return {isLogin: false,user:'',sex:'unkown'};
				},
				onChildChanged: function (newLogin) {
				   this.setState({
				    isLogin: newLogin[0],
				    userName:newLogin[1],
				    sex:newLogin[2]
				  });
				},
				onChangeFlag(newFlag){
					this.props.oncallback(newFlag);
				},
				render:function(){
					var amLogin = this.state.userName
					var sex = this.state.sex
					var flag = this.props.flag;
					//console.warn(flag)
					return (
						<div className="acountEnter">
							<HeadImgComponent isLogin={this.state.isLogin} callbackParent={this.onChildChanged} sex={sex}/>
							<p style={{color:'white',textAlign:'center',fontSize:'25px'}}>{amLogin}</p>
							<EnterComponent isLogin={this.state.isLogin} callbackParent={this.onChildChanged} flag = {flag} oncallback1={this.onChangeFlag}/>
						</div>
					)
				}
			})

		// 页脚统计组件
			var TotalCountComponent = React.createClass({
				render:function(){
					var totalCount = 0;
					this.props.stodos.forEach(c=>{
						totalCount += c.amount;
					});
					totalCount += '';
					
					//console.info(typeof totalCount)
					
					totalCount = CashTo3(totalCount);
					//console.log(typeof totalCount)
					return (
						<p style={{textAlign:'right'}}>总计&nbsp;￥ {totalCount}</p>
					)
				}
			}) 

		// 表单组件
			var TableComponent = React.createClass({
				getInitialState:function(){
					return {stodo:this.props.stodos}
				},
				render:function(){
					var todolist = [];
					this.state.stodo.forEach((todo,index)=>{
						todolist.push(<Todo todo={todo} key={index} pos={index}/>)
					});
					return (
						<table className="imageTable">
							<thead>
								<tr>
									<th>序号</th>
									<th>日期</th>
									<th>项目</th>
									<th>事由</th>
									<th>金额</th>
									<th>经办人</th>
								</tr>
							</thead>
							<tbody>{todolist}</tbody>
						</table>
					)
				}
			})

		// 表-行 组件
			var Todo = React.createClass({
				showMeSomething:function(e){
					
					var text = e.target.parentNode.innerText;
					//console.info(text)
					//console.warn(this.props.index);
					var node = text.replace(/\s/g,'+').split('+')
					//console.log(node)	
					var oDiv = document.querySelector('#tips');
				   	oDiv.innerText = `序号 -> ${node[0]} \n 时间 -> ${node[1]}  ${node[2]} \n项目 -> ${node[3]} \n事由 -> ${node[4]} \n金额 -> ${node[5]} \n经办人 -> ${node[6]}`;
					oDiv.style.left = e.clientX + 'px'
					oDiv.style.top = e.clientY + 'px'
					oDiv.style.display = 'block'
					//console.log(oDiv)
					//console.info(e.clientX)
				},
				hideMeMessage:function(){
					document.querySelector('#tips').style.display = 'none'
				},
		        render: function() {
		          return (
		                <tr onMouseOver={this.showMeSomething} onMouseLeave={this.hideMeMessage} className="HighLight">
							<td className='Order'>{this.props.pos+1}</td>
							<td className='left' style={{width:'15rem'}}>{this.props.todo.date}</td>
							<td className='left'>{this.props.todo.project}</td>
							<td className='left'>{this.props.todo.cause}</td>
							<td className='right'>{this.props.todo.amount}元</td>
							<td className='hander'>{this.props.todo.creater}</td>
						</tr>
		            );
		        }
		    });	


		// 页眉组件
			var TodoListsComponent = React.createClass({
				render:function(){
					var todos = this.props.todoList
					return (
						<div>
							<TableComponent stodos={todos} />
							<TotalCountComponent stodos={todos}/>
						</div>
					)
				}
			})


		// 内容组件
			var ContentComponent = React.createClass({
				componentWillMount(){
					getData()
				},
				render:function(){
					var todoList = this.props.todoLists
					return <TodoListsComponent todoList={todoList} />
				}
			})

		// 大包装
			var App = React.createClass({
				getInitialState:function(){
					return {flag:false,isLogin:false}
				},
				
				changeFlag:function(newFlag){
					this.setState({flag:newFlag[0],isLogin:newFlag[1]})
				},
				render:function(){
					var isLogin = this.state.isLogin;
					//console.log(localStorage.getItem('item'))
					var user = localStorage.getItem('item')
					//console.error(isLogin)
					// 渲染进程（响应） -> 进入主页
					//console.error(isLogin)
					if(stodoLists.length >0 && isLogin) audio.play()
					ipcRenderer.on('HelloMan',()=>{
						//  必须在已经登录的状态才能进入主页
						this.state.isLogin && this.setState({flag:true})
						this.state.isLogin || alert('Please login first')
					});
					// 渲染进程（响应）-> 注销
					ipcRenderer.on('sayWhat',()=>{
						localStorage.removeItem('item')
						document.title = '消息助手'
						this.setState({flag:false,isLogin:false})
					});
					//console.log(this.state.userName+'11111111111')
					var tmp = this.state.flag?<ContentComponent todoLists={stodoLists}/>: <LoginComponent flag={this.state.flag} oncallback={this.changeFlag}/>
					return (
						<div>{tmp}</div>
					)
				}
			})
			const ipcRenderer = require('electron').ipcRenderer;
			ipcRenderer.send('sayHi')
			ReactDOM.render(
				<div>
					<App />
					
				</div>
				,document.getElementById('example')
			);
		</script>
	</body>
</html>